<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path Simulator</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cookie">
    <link rel="stylesheet" href="assets/bootstrap/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/Pretty-Footer.css">
    <link rel="stylesheet" href="assets/css/Pretty-Header.css">
</head>

<body>
    <nav class="navbar navbar-default custom-header">
        <div class="container-fluid">
            <div class="navbar-header"><a class="navbar-brand navbar-link" href="#">PathSimulator<span>Beta </span> </a>
                <button class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button>
            </div>
            <div class="collapse navbar-collapse" id="navbar-collapse">
<!--
                <ul class="nav navbar-nav links">
                    <li role="presentation"><a href="#">Overview </a></li>
                    <li role="presentation"><a href="#">Surveys </a></li>
                    <li role="presentation"><a href="#">Reports </a></li>
                    <li role="presentation"><a href="#" class="custom-navbar">Roles <span class="badge">new</span></a></li>
                </ul>
-->
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false" href="#"> <span class="caret"></span> Ming <img src="assets/img/avatar.jpg" class="dropdown-image"></a>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu">
                            <li><a href="#">Settings </a></li>
                            <li><a href="#">Payments </a></li>
                            <li class="active"><a href="#">Logout </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="row">
        <div class="col-md-6">
            <canvas id="simulator" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas> 
        </div>
        
        <div class="col-md-6">
            <div id="editor">function algorithm() { 
    token += 1;
    token = token % 15;
    if (token === 0) {
    
        if (drone.rssi > 0) {
            drone.acc = 100;
            if (in_region === 0) {
	        if (Math.random() > 0.5) {
                    drone.turn_left(5);
                    last_move = 0;
                }
	        else {
                    drone.turn_right(5);
                    last_move = 1;
                }
                in_region = 1;
            }
            else {
                if (drone.rssi > last_rssi) {
                    // do nothing, keep going
                }
                else {
                    if (last_move === 0) drone.turn_left(180-10*Math.random());
                    else drone.turn_right(180-10*Math.random());
                }
            }
            last_rssi = drone.rssi;
        }

        else {
            in_region = 0;
            drone.acc = 200;
                if (Math.random() > 0.5)
                    drone.turn_left(Math.random()*50);
	        else
                    drone.turn_right(Math.random()*50);
        }
    
    }
    else {
        drone.acc = 0;
    }
}
            </div>
            <script src="assets/js/ace.js" type="text/javascript" charset="utf-8"></script>
            <script src="assets/js/theme-twilight.js" type="text/javascript" charset="utf-8"></script>
            <script src="assets/js/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
            <script>
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/twilight");
                editor.setFontSize(18);
                var JavaScriptMode = ace.require("ace/mode/javascript").Mode;
                editor.session.setMode(new JavaScriptMode());
            </script>        
        </div>
    </div>
    <div class="btn-group" role="group">
        <button onclick="start();" class="btn btn-default" type="button">Start</button>
        <button onclick="pause();" class="btn btn-default" type="button">Pause</button>
        <button onclick="reset();" class="btn btn-default" type="button">Reset</button>
    </div>


<script>
var canvas = document.getElementById("simulator");
canvas.width = 900;
canvas.height = 600;
var ctx = canvas.getContext("2d");
var frame_rate = 60;
var is_start = false;
var is_pause = false;
var simulator;
var update_algorithm;
var rssi_radius = 200;
var alpha = 0.9;
var boundary_space = 10;
var drone = {};
var path = {}; // dummy, for readibility
path.algorithm = [];
function init_envvar() {
   drone.cur_x = 100;
   drone.cur_y = 100;
   drone.speed_x = 0;
   drone.speed_y = 0;
   drone.acc_x = 0;
   drone.acc_y = 0;
   drone.rssi;
   drone.shape = [[0,-15],[-5,0],[5,0]]
   // user control
   drone.head = 180; // degree
   drone.acc = 0;
   drone.turn_left = function(degree) {
      drone.head -= degree;
      drone.head = drone.head % 360;
   }
   drone.turn_right = function(degree) {
      drone.head += degree;
      drone.head = drone.head % 360;
   }
}

/*
function init_algorithmlist() {
   document.getElementById("algorithm").options.length = 0;
   var algorithm_list = document.getElementById("algorithm");
   for(var i = 0; i < path.algorithm.length; i += 1) {
      var option = document.createElement("option");
      option.text = path.algorithm[i];
      option.value = path.algorithm[i];
      algorithm_list.add(option);
   }
}
*/

function init_rssi() {
   var grd = ctx.createRadialGradient(canvas.width/2, canvas.height/2, rssi_radius, canvas.width/2, canvas.height/2, 0);
   grd.addColorStop(1, "red");
   grd.addColorStop(0, "white");
   ctx.fillStyle = grd;
   ctx.beginPath();
   ctx.arc(canvas.width/2, canvas.height/2, rssi_radius, 0, 2 * Math.PI);
   ctx.fill();
   ctx.closePath();
}
function update_drone() {
   if(!is_pause) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      init_rssi();
      var p = ctx.getImageData(drone.cur_x, drone.cur_y, 10, 10).data;
      drone.rssi = p[1] == 0 ? 0 : 255-p[1];
      ctx.save();
      ctx.translate(drone.cur_x, drone.cur_y);
      ctx.rotate(drone.head*Math.PI/180);
      ctx.fillStyle = "green";
      ctx.beginPath();
      ctx.moveTo(drone.shape[0][0],drone.shape[0][1]);
      ctx.lineTo(drone.shape[1][0],drone.shape[1][1]);
      ctx.lineTo(drone.shape[2][0],drone.shape[2][1]);
      ctx.closePath();
      ctx.stroke();
      ctx.fill();
      ctx.restore();
      // project of acc on x, y
      drone.acc_x = drone.acc * Math.cos((drone.head-90)*Math.PI/180);
      drone.acc_y = drone.acc * Math.sin((drone.head-90)*Math.PI/180);
      // v = v + at
      drone.speed_x += drone.acc_x/frame_rate;
      drone.speed_y += drone.acc_y/frame_rate;
      // fading
      drone.speed_x *= alpha;
      drone.speed_y *= alpha;
      drone.cur_x += drone.speed_x;
      drone.cur_y += drone.speed_y;
      
      // boundary
      if (drone.cur_x >= canvas.width-boundary_space | drone.cur_x <= boundary_space) {
         drone.cur_x = Math.min(Math.max(boundary_space, drone.cur_x), canvas.width-boundary_space);
      }
      if (drone.cur_y >= canvas.height-boundary_space | drone.cur_y <= boundary_space) {
         drone.cur_y = Math.min(Math.max(boundary_space, drone.cur_y), canvas.height-boundary_space);
      }
      window['RandomWalk']();
      document.getElementById("x").innerHTML = drone.cur_x;
      document.getElementById("y").innerHTML = drone.cur_y;
      document.getElementById("v_x").innerHTML = drone.speed_x;
      document.getElementById("v_y").innerHTML = drone.speed_y;
      document.getElementById("a_x").innerHTML = drone.acc_x;
      document.getElementById("a_y").innerHTML = drone.acc_y;
      document.getElementById("rssi").innerHTML = drone.rssi;
      document.getElementById("head").innerHTML = drone.head;
      document.getElementById("acc").innerHTML = drone.acc;
   }
}
function start() {
   if (!is_start) {
      //update_algorithm = document.getElementById("algorithm").value;
      simulator = setInterval(update_drone, 1000/frame_rate);
      is_start = true;
   }
}
function pause() {
   is_pause = ~is_pause;
   document.getElementById("button_pause").innerHTML = (is_pause) ? "Resume" : "Pause"; 
}
function reset() {
   clearInterval(simulator);
   ctx.clearRect(0, 0, canvas.width, canvas.width);
   init_rssi();
   init_envvar();
   //init_algorithmlist();
   is_start = false;
   is_pause = false;
   document.getElementById("x").innerHTML = "";
   document.getElementById("y").innerHTML = "";
   document.getElementById("v_x").innerHTML = "";
   document.getElementById("v_y").innerHTML = "";
   document.getElementById("a_x").innerHTML = "";
   document.getElementById("a_y").innerHTML = "";
   document.getElementById("rssi").innerHTML = "";
}
init_rssi();
init_envvar();
</script>

<script src="algo.js"></script>

<script>
   init_algorithmlist();
</script>



    <footer>
        <div class="row">
            <div class="col-md-4 col-sm-6 footer-navigation">
                <p class="company-name">Ming Â© 2016 </p>
            </div>
            <div class="col-md-4 col-sm-6 footer-contacts">
                <div><span class="fa fa-envelope footer-contacts-icon"></span>
                    <p> <a href="#" target="_blank">rf37535@gmail.com</a></p>
                </div>
            </div>
            <div class="clearfix visible-sm-block"></div>
            <div class="col-md-4 footer-about">
                <h4>Reserved</h4>
                <p> Lorem ipsum dolor sit amet, consectateur adispicing elit. Fusce euismod convallis velit, eu auctor lacus vehicula sit amet.
                </p>
                <div class="social-links social-icons"><a href="#"><span class="fa fa-facebook"></span></a><a href="#"><span class="fa fa-twitter"></span></a><a href="#"><span class="fa fa-linkedin"></span></a><a href="#"><span class="fa fa-github"></span></a></div>
            </div>
        </div>
    </footer>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>
